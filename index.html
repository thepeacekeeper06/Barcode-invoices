<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KL Technology Solutions - Invoice Barcode Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .barcode-icon {
            font-size: 2rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #64748b;
        }

        .tab.active {
            background: white;
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .tab:hover {
            background: #f1f5f9;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-title {
            font-size: 1.5rem;
            color: #1e293b;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: #f9fafb;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4f46e5;
            background: white;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            width: 100%;
            justify-content: center;
            padding: 18px;
            font-size: 1.1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .print-stack {
            background: #f8fafc;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
        }

        .print-stack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .print-stack-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .print-buttons {
            display: flex;
            gap: 10px;
        }

        .print-buttons .btn {
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .print-stack-content {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .print-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .barcode-container {
            text-align: center;
            margin: 20px 0;
        }

        .barcode-container canvas {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .invoice-details {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .invoice-details h3 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .invoice-field {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .invoice-field:last-child {
            border-bottom: none;
        }

        .invoice-field strong {
            color: #374151;
        }

        .empty-state {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .scan-section {
            text-align: center;
        }

        .scan-input-group {
            max-width: 500px;
            margin: 0 auto 30px;
        }

        .scan-input-group input {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            text-align: center;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 25px;
            }

            .header h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 10px;
            }

            .tab-content {
                padding: 25px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .print-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 0.9rem;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="barcode-icon">|||||||</span> KL Technology Solutions</h1>
            <p>Invoice Barcode Management System</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('generate')">
                <span>‚ûï</span> Generate
            </div>
            <div class="tab" onclick="switchTab('scan')">
                <span>üì±</span> Scan
            </div>
        </div>

        <div id="generate-tab" class="tab-content active">
            <div class="form-section">
                <h2 class="form-title">‚ûï Generate New Invoice Barcode</h2>
                
                <form id="invoice-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="invoiceNumber">Invoice Number</label>
                            <input type="text" id="invoiceNumber" placeholder="e.g., INV-2025-001" required>
                        </div>
                        <div class="form-group">
                            <label for="ewaybillNo">E-way Bill Number</label>
                            <input type="text" id="ewaybillNo" placeholder="e.g., 123456789012" required>
                        </div>
                        <div class="form-group">
                            <label for="gstNumber">GST Number</label>
                            <input type="text" id="gstNumber" placeholder="e.g., 22AAAAA0000A1Z5" required>
                        </div>
                        <div class="form-group">
                            <label for="productId">Product ID</label>
                            <input type="text" id="productId" placeholder="e.g., PROD-001" required>
                        </div>
                        <div class="form-group">
                            <label for="quantity">Quantity</label>
                            <input type="number" id="quantity" placeholder="e.g., 5" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="totalCost">Total Cost (‚Çπ)</label>
                            <input type="number" id="totalCost" placeholder="e.g., 1500.00" min="0" step="0.01" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <span>‚ö°</span> Generate Invoice Barcode
                    </button>
                </form>

                <div id="message-container"></div>
            </div>

            <div class="print-stack">
                <div class="print-stack-header">
                    <h3 class="print-stack-title">üìã Print Stack (<span id="stack-count">0</span>)</h3>
                    <div class="print-buttons">
                        <button class="btn btn-success" onclick="printAll()">üñ®Ô∏è Print All</button>
                        <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear All</button>
                    </div>
                </div>
                <div class="print-stack-content" id="print-stack">
                    <div class="empty-state">The print stack is empty.</div>
                </div>
            </div>
        </div>

        <div id="scan-tab" class="tab-content">
            <div class="scan-section">
                <h2 class="form-title">üì± Scan Invoice Barcode</h2>
                <p style="margin-bottom: 25px; color: #6b7280;">Enter the barcode ID to retrieve invoice details</p>
                
                <div class="scan-input-group">
                    <input type="text" id="scan-input" placeholder="Enter barcode ID (e.g., KLT-1234567890-001)" 
                           onkeypress="handleScanEnter(event)">
                    <button class="btn btn-primary" onclick="scanBarcode()" style="margin-top: 15px; width: 100%;">
                        üîç Scan Barcode
                    </button>
                </div>

                <div id="scan-message-container"></div>
                <div id="scanned-invoice-details"></div>
            </div>
        </div>

        <div class="footer">
            ¬© 2025 KL Technology Solutions. All rights reserved.
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzd5u_Y-Jy09xZhTgTLK6zC9BkIMUOeNCafvyDKTcSJLED0de0Gr1PlzRY0BeSgn1IwyA/exec';
        let printStack = [];

        // Tab switching functionality
        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Handle form submission
        document.getElementById('invoice-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                action: 'generateInvoice',
                invoice: {
                    invoiceNumber: document.getElementById('invoiceNumber').value,
                    ewaybillNo: document.getElementById('ewaybillNo').value,
                    gstNumber: document.getElementById('gstNumber').value,
                    productId: document.getElementById('productId').value,
                    quantity: document.getElementById('quantity').value,
                    totalCost: document.getElementById('totalCost').value
                }
            };

            try {
                showMessage('Generating invoice...', 'info');
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    showMessage(`Invoice generated successfully! ID: ${result.invoiceId}`, 'success');
                    addToPrintStack(result.invoiceData);
                    document.getElementById('invoice-form').reset();
                } else {
                    showMessage(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            }
        });

        // Add invoice to print stack
        function addToPrintStack(invoiceData) {
            printStack.push(invoiceData);
            updatePrintStackDisplay();
        }

        // Update print stack display
        function updatePrintStackDisplay() {
            const stackElement = document.getElementById('print-stack');
            const countElement = document.getElementById('stack-count');
            
            countElement.textContent = printStack.length;
            
            if (printStack.length === 0) {
                stackElement.innerHTML = '<div class="empty-state">The print stack is empty.</div>';
                return;
            }

            stackElement.innerHTML = printStack.map((invoice, index) => `
                <div class="print-item">
                    <div>
                        <strong>${invoice.invoiceNumber}</strong> - ${invoice.productId}
                        <br>
                        <small>ID: ${invoice.id}</small>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="printSingle(${index})">üñ®Ô∏è Print</button>
                        <button class="btn btn-danger" onclick="removeFromStack(${index})">‚ùå</button>
                    </div>
                </div>
            `).join('');
        }

        // Print single barcode
        function printSingle(index) {
            const invoice = printStack[index];
            generateAndPrintBarcode(invoice);
        }

        // Print all barcodes
        function printAll() {
            if (printStack.length === 0) {
                showMessage('No items in print stack', 'error');
                return;
            }
            
            printStack.forEach(invoice => {
                generateAndPrintBarcode(invoice);
            });
        }

        // Generate and print barcode
        function generateAndPrintBarcode(invoice) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice Barcode - ${invoice.invoiceNumber}</title>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            text-align: center; 
                            padding: 20px;
                            background: white;
                        }
                        .barcode-wrapper {
                            border: 2px solid #000;
                            padding: 20px;
                            margin: 20px auto;
                            width: fit-content;
                            background: white;
                        }
                        .invoice-info {
                            margin: 15px 0;
                            text-align: left;
                            max-width: 400px;
                            margin: 15px auto;
                        }
                        .invoice-info div {
                            margin: 5px 0;
                            display: flex;
                            justify-content: space-between;
                        }
                        h2 { color: #4f46e5; margin-bottom: 20px; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h2>KL Technology Solutions</h2>
                    <h3>Invoice: ${invoice.invoiceNumber}</h3>
                    
                    <div class="barcode-wrapper">
                        <canvas id="barcode"></canvas>
                    </div>
                    
                    <div class="invoice-info">
                        <div><strong>Invoice ID:</strong> <span>${invoice.id}</span></div>
                        <div><strong>E-way Bill:</strong> <span>${invoice.ewaybillNo}</span></div>
                        <div><strong>GST Number:</strong> <span>${invoice.gstNumber}</span></div>
                        <div><strong>Product ID:</strong> <span>${invoice.productId}</span></div>
                        <div><strong>Quantity:</strong> <span>${invoice.quantity}</span></div>
                        <div><strong>Total Cost:</strong> <span>‚Çπ${invoice.totalCost}</span></div>
                        <div><strong>Created:</strong> <span>${new Date(invoice.creationDate).toLocaleString()}</span></div>
                    </div>
                    
                    <p class="no-print" style="margin-top: 30px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 5px; cursor: pointer;">Print</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Close</button>
                    </p>
                    
                    <script>
                        JsBarcode("#barcode", "${invoice.id}", {
                            format: "CODE128",
                            width: 2,
                            height: 100,
                            displayValue: true,
                            fontSize: 16,
                            margin: 10
                        });
                        
                        // Auto-print after barcode is generated
                        setTimeout(() => {
                            window.print();
                        }, 500);
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Remove from print stack
        function removeFromStack(index) {
            printStack.splice(index, 1);
            updatePrintStackDisplay();
        }

        // Clear all from print stack
        function clearAll() {
            if (printStack.length === 0) {
                showMessage('Print stack is already empty', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to clear all items from the print stack?')) {
                printStack = [];
                updatePrintStackDisplay();
                showMessage('Print stack cleared', 'success');
            }
        }

        // Handle scan enter key
        function handleScanEnter(event) {
            if (event.key === 'Enter') {
                scanBarcode();
            }
        }

        // Scan barcode functionality
        async function scanBarcode() {
            const barcodeId = document.getElementById('scan-input').value.trim();
            
            if (!barcodeId) {
                showScanMessage('Please enter a barcode ID', 'error');
                return;
            }

            try {
                showScanMessage('Scanning barcode...', 'info');
                
                const response = await fetch(`${SCRIPT_URL}?action=getInvoiceById&id=${encodeURIComponent(barcodeId)}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    showScanMessage('Invoice found successfully!', 'success');
                    displayInvoiceDetails(result.invoice);
                } else {
                    showScanMessage(`Error: ${result.message}`, 'error');
                    document.getElementById('scanned-invoice-details').innerHTML = '';
                }
            } catch (error) {
                showScanMessage(`Error: ${error.message}`, 'error');
                document.getElementById('scanned-invoice-details').innerHTML = '';
            }
        }

        // Display invoice details
        function displayInvoiceDetails(invoice) {
            const detailsContainer = document.getElementById('scanned-invoice-details');
            
            detailsContainer.innerHTML = `
                <div class="invoice-details">
                    <h3>üìÑ Invoice Details</h3>
                    <div class="invoice-field">
                        <span><strong>Invoice ID:</strong></span>
                        <span>${invoice.id}</span>
                    </div>
                    <div class="invoice-field">
                        <span><strong>Invoice Number:</strong></span>
                        <span>${invoice.invoiceNumber}</span>
                    </div>
                    <div class="invoice-field">
                        <span><strong>E-way Bill Number:</strong></span>
                        <span>${invoice.ewaybillNo}</span>
                    </div>
                    <div class="invoice-field">
                        <span><strong>GST Number:</strong></span>
                        <span>${invoice.gstNumber}</span>
                    </div>
                    <div class="invoice-field">
                        <span><strong>Product ID:</strong></span>
                        <span>${invoice.productId}</span>
                    </div>
                    <div class="invoice-field">
                        <span><strong>Quantity:</strong></span>
                        <span>${invoice.quantity}</span>
                    </div>
                    <div class="invoice-field">
                        <span><strong>Total Cost:</strong></span>
                        <span>‚Çπ${invoice.totalCost}</span>
                    </div>
                    <div class="invoice-field">
                        <span><strong>Company:</strong></span>
                        <span>${invoice.companyName}</span>
                    </div>
                    <div class="invoice-field">
                        <span><strong>Created Date:</strong></span>
                        <span>${new Date(invoice.creationDate).toLocaleString()}</span>
                    </div>
                    <div class="invoice-field">
                        <span><strong>Created By:</strong></span>
                        <span>${invoice.createdBy}</span>
                    </div>
                    <div class="invoice-field">
                        <span><strong>Status:</strong></span>
                        <span style="color: #10b981; font-weight: bold;">${invoice.status}</span>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="printScannedInvoice('${invoice.id}')">
                            üñ®Ô∏è Print Barcode
                        </button>
                        <button class="btn btn-secondary" onclick="addScannedToPrintStack()" style="margin-left: 10px;">
                            ‚ûï Add to Print Stack
                        </button>
                    </div>
                </div>
            `;
        }

        // Print scanned invoice
        function printScannedInvoice(invoiceId) {
            const invoice = JSON.parse(document.getElementById('scanned-invoice-details').dataset.invoice || '{}');
            if (invoice.id) {
                generateAndPrintBarcode(invoice);
            }
        }

        // Add scanned invoice to print stack
        function addScannedToPrintStack() {
            const detailsContainer = document.getElementById('scanned-invoice-details');
            const invoiceFields = detailsContainer.querySelectorAll('.invoice-field');
            
            if (invoiceFields.length > 0) {
                const invoice = {};
                invoiceFields.forEach(field => {
                    const spans = field.querySelectorAll('span');
                    const key = spans[0].textContent.replace(':', '').replace('Invoice ID', 'id')
                        .replace('Invoice Number', 'invoiceNumber')
                        .replace('E-way Bill Number', 'ewaybillNo')
                        .replace('GST Number', 'gstNumber')
                        .replace('Product ID', 'productId')
                        .replace('Total Cost', 'totalCost')
                        .replace('Company', 'companyName')
                        .replace('Created Date', 'creationDate')
                        .replace('Created By', 'createdBy');
                    const value = spans[1].textContent.replace('‚Çπ', '');
                    
                    const fieldMap = {
                        'Invoice ID': 'id',
                        'Invoice Number': 'invoiceNumber',
                        'E-way Bill Number': 'ewaybillNo',
                        'GST Number': 'gstNumber',
                        'Product ID': 'productId',
                        'Quantity': 'quantity',
                        'Total Cost': 'totalCost',
                        'Company': 'companyName',
                        'Created Date': 'creationDate',
                        'Created By': 'createdBy',
                        'Status': 'status'
                    };
                    
                    const actualKey = fieldMap[spans[0].textContent.replace(':', '')] || key;
                    invoice[actualKey] = value;
                });
                
                addToPrintStack(invoice);
                showScanMessage('Invoice added to print stack!', 'success');
            }
        }

        // Show message functions
        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const messageClass = type === 'success' ? 'success-message' : type === 'error' ? 'error-message' : 'info-message';
            
            container.innerHTML = `<div class="${messageClass}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function showScanMessage(message, type) {
            const container = document.getElementById('scan-message-container');
            const messageClass = type === 'success' ? 'success-message' : type === 'error' ? 'error-message' : 'info-message';
            
            container.innerHTML = `<div class="${messageClass}">${message}</div>`;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('KL Technology Solutions Invoice Barcode Management System loaded');
        });
    </script>
</body>
</html>
